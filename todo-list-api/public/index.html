<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>To-Do API Tester</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input, select, button, textarea { padding:8px; font-size:14px; }
    label { font-weight:600; }
    .row { display:flex; gap:10px; margin:8px 0; flex-wrap:wrap; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f7f7f7; }
    .status { font-size: 12px; color: #555; }
    .danger { color: #b00020; }
  </style>
</head>
<body>
  <header>
    <h1>To-Do API Tester</h1>
    <span class="status" id="status">Backend: http://localhost:3000</span>
  </header>

  <section>
    <h2>Auth</h2>
    <div class="row">
      <label for="token">JWT Bearer Token:</label>
      <input id="token" type="text" size="80" placeholder="Cole seu token JWT aqui" />
      <button id="saveToken">Usar token</button>
      <button id="mockLogin">Obter token de teste</button>
    </div>
  </section>

  <section>
    <h2>Criar tarefa</h2>
    <div class="row">
      <input id="title" placeholder="Título" />
      <input id="description" placeholder="Descrição" />
      <select id="priority">
        <option value="low">low</option>
        <option value="medium" selected>medium</option>
        <option value="high">high</option>
      </select>
      <select id="statusSel">
        <option value="pending" selected>pending</option>
        <option value="in-progress">in-progress</option>
        <option value="completed">completed</option>
      </select>
      <input id="dueDate" type="date" />
      <button id="createBtn">Criar</button>
    </div>
  </section>

  <section>
    <h2>Lista de tarefas</h2>
    <button id="refreshBtn">Recarregar</button>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Título</th>
          <th>Status</th>
          <th>Prioridade</th>
          <th>Prazo</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

  <script>
    const API = location.origin.replace(/\/$/, '') + '/api/tasks';
    let authHeader = {};

    function setToken() {
      const t = document.getElementById('token').value.trim();
      authHeader = t ? { 'Authorization': 'Bearer ' + t } : {};
      localStorage.setItem('jwt', t);
      alert('Token atualizado');
    }

    document.getElementById('saveToken').onclick = setToken;
    document.getElementById('token').value = localStorage.getItem('jwt') || '';
    if (document.getElementById('token').value) setToken();

    document.getElementById('mockLogin').onclick = async () => {
      try {
        const res = await fetch(location.origin.replace(/\/$/, '') + '/api/auth/mock-login', { method: 'POST' });
        const txt = await res.text();
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText + ' - ' + txt);
        let data = {};
        try { data = txt ? JSON.parse(txt) : {}; } catch { throw new Error('Resposta não é JSON: ' + txt); }
        document.getElementById('token').value = data.token || '';
        setToken();
      } catch (e) {
        alert('Falha ao obter token de teste: ' + e.message);
      }
    };

    async function fetchJSON(url, options={}) {
      const res = await fetch(url, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          ...authHeader,
          ...(options.headers || {})
        }
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(res.status + ' ' + res.statusText + ' - ' + text);
      }
      if (res.status === 204) return null;
      return res.json();
    }

    async function loadTasks() {
      try {
        const data = await fetchJSON(API);
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        data.forEach(t => tbody.appendChild(rowFor(t)));
      } catch (e) {
        console.error(e);
        alert('Falha ao carregar tarefas: ' + e.message);
      }
    }

    function rowFor(t) {
      const tr = document.createElement('tr');
      const due = t.dueDate ? new Date(t.dueDate).toLocaleDateString() : '';
      tr.innerHTML = `
        <td>${t._id || t.id || ''}</td>
        <td>${t.title || ''}</td>
        <td>${t.status || ''}</td>
        <td>${t.priority || ''}</td>
        <td>${due}</td>
        <td>
          <button data-id="${t._id || t.id}" class="done">Concluir</button>
          <button data-id="${t._id || t.id}" class="del danger">Excluir</button>
        </td>
      `;
      tr.querySelector('.done').onclick = () => updateTask(t._id || t.id, { status: 'completed' });
      tr.querySelector('.del').onclick = () => deleteTask(t._id || t.id);
      return tr;
    }

    async function createTask() {
      const body = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        priority: document.getElementById('priority').value,
        status: document.getElementById('statusSel').value,
        dueDate: document.getElementById('dueDate').value ? new Date(document.getElementById('dueDate').value) : undefined,
      };
      try {
        await fetchJSON(API, { method: 'POST', body: JSON.stringify(body) });
        await loadTasks();
      } catch (e) {
        alert('Falha ao criar: ' + e.message);
      }
    }

    async function updateTask(id, patch) {
      try {
        await fetchJSON(`${API}/${id}`, { method: 'PUT', body: JSON.stringify(patch) });
        await loadTasks();
      } catch (e) {
        alert('Falha ao atualizar: ' + e.message);
      }
    }

    async function deleteTask(id) {
      try {
        await fetchJSON(`${API}/${id}`, { method: 'DELETE' });
        await loadTasks();
      } catch (e) {
        alert('Falha ao excluir: ' + e.message);
      }
    }

    document.getElementById('createBtn').onclick = createTask;
    document.getElementById('refreshBtn').onclick = loadTasks;

    loadTasks();
  </script>
</body>
</html>
